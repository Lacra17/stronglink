-- Unfortunately, the output of `sqlite3 .dump` is ugly, so this file should be generated by hand.
-- Not to mention, SQLite3 barely supports ALTER TABLE.

CREATE TABLE "users" (
    "userID" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    "username" TEXT NOT NULL,
    "passhash" TEXT NOT NULL,
    "token" TEXT,
    "creationTime" INTEGER NOT NULL DEFAULT (strftime('%s'))
);
CREATE UNIQUE INDEX "usersIndex" ON "users" ("username" ASC);

CREATE TABLE "sessions" (
    "sessionID" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    "sessionKey" TEXT NOT NULL,
    "userID" INTEGER NOT NULL,
    "creationTime" INTEGER NOT NULL DEFAULT (strftime('%s'))
);
CREATE UNIQUE INDEX "sessionsIndex" ON "sessions" ("sessionID" ASC, "sessionKey" ASC);

CREATE TABLE "files" (
    "fileID" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
    "internalHash" TEXT NOT NULL,
    "type" TEXT NOT NULL,
    "size" INTEGER NOT NULL
);
CREATE UNIQUE INDEX "filesHashIndex" ON "files" ("internalHash" ASC, "type" ASC);

CREATE TABLE "URIs" (
	"URIID" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
	"URI" TEXT NOT NULL
);
CREATE UNIQUE INDEX "URIsIndex" ON "URIs" ("URI" ASC, "URIID" ASC);

CREATE TABLE "links" (
	"linkID" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
	"sourceURIID" TEXT NOT NULL,
	"targetURIID" TEXT NOT NULL,
	"fileID" INTEGER NOT NULL
);
CREATE INDEX "linksSourceIndex" ON "links" ("sourceURIID" ASC);
CREATE INDEX "linksTargetIndex" ON "links" ("targetURIID" ASC);

CREATE TABLE "fileURIs" (
	"fileURIID" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
	"fileID" INTEGER NOT NULL,
	"URIID" INTEGER NOT NULL
);
CREATE UNIQUE INDEX "fileURIsIndex" ON "fileURIs" ("URIID" ASC, "fileID" ASC);

CREATE VIRTUAL TABLE "fulltext" USING "fts4" (
	content="",
	"text" TEXT
);
CREATE TABLE "fileContent" (
	"fileContentID" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
	"ftID" INTEGER NOT NULL,
	"fileID" INTEGER NOT NULL
);
CREATE UNIQUE INDEX "fileContentIndex" ON "fileContent" ("ftID" ASC, "fileID" ASC);

CREATE TABLE "filePermissions" (
	"filePermissionID" INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
	"fileID" INTEGER NOT NULL,
	"userID" INTEGER NOT NULL,
	"grantorID" INTEGER NOT NULL,
	"grantTime" INTEGER NOT NULL DEFAULT (strftime('%s'))
);
CREATE UNIQUE INDEX "filePermissionIndex" ON "filePermissions" ("userID" ASC, "fileID" ASC, "grantorID" ASC);

