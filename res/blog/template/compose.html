<!doctype html>
<meta charset="utf-8">
<title>{{reponame}} submission</title>
<link rel="stylesheet" type="text/css" href="/index.css">
<style>
.absolute { position: absolute; }
.full { top: 0; bottom: 0; left: 0; right: 0; }
.toolbar { bottom: 0; left: 0; right: 0; height: 30px; border-top: 1px solid #555; }
.editor { bottom: 30px; left: 0; right: 0; top: 0; }
.textarea, .preview { top: 0; height: 100%; border: none; font-family: "Helvetica", sans-serif; font-size: 16px; }
.textarea { left: 0; width: 50%; padding: 1em; outline: none; }
.preview { right: 0; width: 50%; border-left: 1px solid #555; }
.scroll { overflow: auto; overflow-x: hidden; }
.button { background: -webkit-linear-gradient(top, #eee, #ddd); background: -moz-linear-gradient(top, #eee, #ddd); }
.button:active { background: -webkit-linear-gradient(top, #ddd, #eee); background: -moz-linear-gradient(top, #ddd, #eee); }
.toolbar > .button { height: 100%; }
.toolbar > .padding { padding: 0 1em; }
.toolbar > .label { font-size: small; }
.submit { border-width: 0 0 0 1px; }
</style>
<script src="/commonmark.js"></script>

<form method="POST" action="/submission" enctype="multipart/form-data">
<!--<input type="hidden" name="token" value="{{token}}">-->
<!--TODO-->

<div class="absolute full">
	<div class="absolute toolbar">
		<div class="label padding floatl"><a href="#">Markdown help</a></div> <!--TODO-->
		<input class="submit border button padding floatr" type="submit" value="Submit">
		<div class="label padding floatr"><a href="/">Cancel</a></div>
	</div>
	<div class="absolute editor">
		<textarea id="input" name="markdown" class="absolute textarea"></textarea>
		<div id="output" class="absolute preview content scroll"></div>
	</div>
</div>

</form>

<script>
var input = document.getElementById("input");
var output = document.getElementById("output");

var parser = new commonmark.Parser();
var renderer = new commonmark.HtmlRenderer({sourcepos: true});
renderer.softbreak = "<br>";

// Ported from C version in markdown.c
// The output should be identical between each version
function md_escape(iter) {
	var event, node, p, text;
	for(;;) {
		event = iter.next();
		if(!event) break;
		if(!event.entering) continue;
		node = event.node;
		if("HtmlBlock" != node.type) continue;

		p = new commonmark.Node("Paragraph");
		text = new commonmark.Node("Text");
		text.literal = node.literal;
		p.appendChild(text);
		node.insertBefore(p);
		node.unlink();
	}
}
function md_escape_inline(iter) {
	var event, node, text;
	for(;;) {
		event = iter.next();
		if(!event) break;
		if(!event.entering) continue;
		node = event.node;
		if("Html" != node.type) continue;

		text = new commonmark.Node("Text");
		text.literal = node.literal;
		node.insertBefore(text);
		node.unlink();
	}
}
function md_autolink(iter) {
	// <http://daringfireball.net/2010/07/improved_regex_for_matching_urls>
	// Painstakingly ported to POSIX and then back
	// TODO: Get original
	// Pretty sure this is broken because it's capturing trailing punctuation...
	var linkify = /([a-z][a-z0-9_-]+:(\/{1,3}|[a-z0-9%])|www[0-9]{0,3}[.]|[a-z0-9.-]+[.][a-z]{2,4}\/)([^\s()<>]+|(([^\s()<>]+|(([^\s()<>]+)))*))+((([^\s()<>]+|(([^\s()<>]+)))*)|[^\[\]\s`!(){};:'".,<>?«»“”‘’])/;
	var event, node, match, str, text, link, face;
	for(;;) {
		event = iter.next();
		if(!event) break;
		if(!event.entering) continue;
		node = event.node;
		if("Text" != node.type) continue;

		str = node.literal;
		while((match = linkify.exec(str))) {
			text = new commonmark.Node("Text");
			link = new commonmark.Node("Link");
			face = new commonmark.Node("Text");
			text.literal = str.slice(0, match.index);
			link.destination = str.slice(match.index, match.index+match[0].length)
			face.literal = link.destination;
			link.appendChild(face);
			node.insertBefore(text);
			node.insertBefore(link);
			str = str.slice(match.index+match[0].length);
		}

		if(str !== node.literal) {
			text = new commonmark.Node("Text");
			text.literal = str;
			node.insertBefore(text);
			node.unlink();
		}
	}
}
function md_convert_hashes(iter) {
	var event, node, URI, hashlink, sup_open, sup_close, face;
	for(;;) {
		event = iter.next();
		if(!event) break;
		if(!event.entering) continue;
		node = event.node;
		if("Link" != node.type) continue;

		URI = node.destination;
		if(!URI) continue;
		if("hash:" != URI.toLowerCase().slice(0, 5)) continue;

		hashlink = new commonmark.Node("Link");
		hashlink.destination = URI;
		hashlink.title = "Hash URI (right click and choose copy link)";

		sup_open = new commonmark.Node("Html");
		sup_close = new commonmark.Node("Html");
		face = new commonmark.Node("Text");
		sup_open.literal = "<sup>[";
		sup_close.literal = "]</sup>";
		face.literal = "#";
		hashlink.appendChild(face);

		node.insertAfter(sup_open);
		sup_open.insertAfter(hashlink);
		hashlink.insertAfter(sup_close);

		iter.resumeAt(sup_close, false);

		node.destination = "../?q="+URI;
	}
}

var coalesce = null;
input.oninput = input.onpropertychange = function() {
	clearTimeout(coalesce); coalesce = null;
	coalesce = setTimeout(function() {
		var node = parser.parse(input.value);
		md_escape(node.walker());
		md_escape_inline(node.walker());
		md_autolink(node.walker());
		md_convert_hashes(node.walker());
		// TODO: Use target=_blank for links.
		output.innerHTML = renderer.render(node);
	}, 1000 * 0.5);
};

var TAB = 9;
input.onkeydown = function(e) {
	if(TAB !== e.keyCode && TAB !== e.which) return;
	e.preventDefault();
	var t = "\t";
	var s = this.selectionStart + t.length;

	// TODO: With long documents, this is slow and messes up scrolling.
	// There's gotta be a better way.
	// Only tested on Firefox so far...
	this.setRangeText(t, this.selectionStart, this.selectionEnd);

	this.setSelectionRange(s, s);

	this.oninput();
};

</script>

